<template>
    <!-- <template lwc:if={showContent}> -->
    <div class="page-background">
        <!-- User has no access to the thread -->
        <template lwc:if={showError}>
            <div class="error-content">
                <p>Du har ikke tilgang til denne samtalen.</p>
                <br />
                <c-button button-styling="Primary" button-label="Gå til hjem" onbuttonclick={goToHome}></c-button>
            </div>
        </template>
        <template lwc:if={isContentReady}>
            <div class="header-content">
                <div class="back-button-info">
                    <c-hot_back-button></c-hot_back-button>
                </div>

                <!-- Conversation with -->
                <div class="header-buttons">
                    <div class="navds-div" tabindex="0" aria-label={threadType}>{threadType}</div>

                    <c-button
                        button-label="Vis personer i samtalen"
                        type="button"
                        onbuttonclick={handleShowParticipants}
                    ></c-button>
                </div>

                <!-- Participants modal -->
                <div>
                    <dialog
                        class="modal-participants modal-container"
                        aria-label="Personer som er med i samtalen"
                        onclose={closeModal}
                    >
                        <template lwc:if={isLoading}>
                            <div class="loader-container">
                                <c-hot_loader size="3xlarge"></c-hot_loader>
                            </div>
                        </template>
                        <template lwc:else>
                            <div class="modal-header">
                                <h2>Personer med i denne samtalen nå:</h2>
                                <button class="close-btn" onclick={closeModal} aria-label="Lukk">
                                    <img src={exitCrossIcon} alt="" aria-hidden="true" />
                                </button>
                            </div>
                            <div class="modal-body">
                                <template for:each={threadParticipants} for:item="participant">
                                    <p class="participant-text" key={participant.userId}>
                                        {participant.name}
                                        <template if:true={participant.role}> ({participant.role}) </template>
                                    </p>
                                </template>
                            </div>
                        </template>
                    </dialog>
                </div>

                <!-- Header -->
                <div>
                    <h1 class="header" role="heading" aria-level="1">{subject}</h1>
                </div>

                <!-- Show Service appointment button -->
                <div class="show-service-assignment">
                    <c-button
                        button-label="Vis oppdrag"
                        class="show-details-button"
                        type="button"
                        onbuttonclick={goToDetails}
                        desktop-style="margin-right: 0.5rem;"
                        mobile-style="margin-right: 0.5rem;"
                    ></c-button>

                    <template lwc:if={showScrollButton}>
                        <c-button
                            button-label="Til siste melding"
                            button-styling="Primary"
                            type="button"
                            aria-label="Til bunnen"
                            onbuttonclick={scrollToLatestMessage}
                        ></c-button>
                    </template>
                </div>

                <!-- Show Service appointment modal -->
                <dialog
                    class="modal-service-appointment modal-container"
                    aria-label="Informasjon om oppdrag"
                    onclose={closeModal}
                >
                    <template lwc:if={isLoading}>
                        <div class="loader-container">
                            <c-hot_loader size="3xlarge"></c-hot_loader>
                        </div>
                    </template>
                    <template lwc:else>
                        <template lwc:if={hasAccess}>
                            <div class="modal-header">
                                <h2>Informasjon om oppdraget:</h2>
                                <button class="close-btn" onclick={closeModal} aria-label="Lukk">
                                    <img src={exitCrossIcon} alt="" aria-hidden="true" />
                                </button>
                            </div>

                            <template lwc:if={isDetailsContent}>
                                <!-- Service Appointment Details -->
                                <template lwc:if={isDetails}>
                                    <div class="modal-body">
                                        <p>Oppdragsnummer: <span>{serviceAppointment.AppointmentNumber}</span></p>
                                        <p>Tema: <span>{serviceAppointment.Subject}</span></p>
                                        <p>Tid: <span>{serviceAppointment.StartAndEndDate}</span></p>
                                        <p>Adresse: <span>{serviceAppointment.HOT_AddressFormated__c}</span></p>

                                        <!-- Show maps if address is present -->
                                        <template lwc:if={serviceAppointment.HOT_AddressFormated__c}>
                                            <div style="display: inline-block; padding-right: 1vw">
                                                <p>Åpne adressen i en karttjeneste (ekstern):</p>
                                                <div class="maps-button-container">
                                                    <c-button
                                                        button-styling="secondary"
                                                        button-label="Google maps"
                                                        onbuttonclick={openGoogleMaps}
                                                    ></c-button>
                                                </div>
                                                <div class="maps-button-container">
                                                    <c-button
                                                        button-styling="secondary"
                                                        button-label="Apple maps"
                                                        onbuttonclick={openAppleMaps}
                                                    ></c-button>
                                                </div>
                                            </div>
                                        </template>

                                        <template lwc:if={accountName}>
                                            <p>
                                                Navn til bruker:&nbsp;
                                                <span> {accountName} ({accountAgeGender})</span>
                                            </p>
                                        </template>

                                        <template lwc:if={accountPhoneNumber}>
                                            <p>
                                                Telefonnummer til bruker:&nbsp;
                                                <span>{accountPhoneNumber}</span>
                                            </p>
                                        </template>

                                        <p>Tolkemetode: <span>{serviceAppointment.HOT_WorkTypeName__c}</span></p>
                                        <p>Oppdragstype: <span>{serviceAppointment.HOT_AssignmentType__c}</span></p>
                                        <p>Eier: <span>{serviceAppointment.HOT_Request__r.OwnerName__c}</span></p>
                                        <p>Status: <span>{serviceAppointment.Status}</span></p>
                                        <p>Region: <span>{serviceAppointment.HOT_ServiceTerritoryName__c}</span></p>
                                        <p>
                                            Haptisk kommunikasjon:&nbsp;
                                            <span>{serviceAppointment.HOT_HapticCommunication__c}</span>
                                        </p>

                                        <template lwc:if={serviceAppointment.HOT_Escort__c}>
                                            <p>Ledsaging: <span>{serviceAppointment.HOT_Escort__c}</span></p>
                                        </template>

                                        <template lwc:if={serviceAppointment.HOT_DegreeOfHearingAndVisualImpairment__c}>
                                            <p>
                                                Vedtak:&nbsp;
                                                <span
                                                    >{serviceAppointment.HOT_DegreeOfHearingAndVisualImpairment__c}</span
                                                >
                                            </p>
                                        </template>

                                        <template lwc:if={interestedResource}>
                                            <p>
                                                Avtalte betingelser:
                                                <span>{interestedResource.HOT_TermsOfAgreement__c}</span>
                                            </p>
                                        </template>

                                        <p>Tilleggsopplysninger: <span>{serviceAppointment.Description}</span></p>

                                        <template lwc:if={ordererPhoneNumber}>
                                            <p>Telefonnummer til bestiller:&nbsp;<span>{ordererPhoneNumber}</span></p>
                                        </template>

                                        <template lwc:if={serviceAppointment.HOT_Dispatcher__c}>
                                            <p>Formidler: <span>{serviceAppointment.HOT_Dispatcher__c}</span></p>
                                        </template>
                                    </div>
                                </template>

                                <!-- Show Interested Resource Details -->
                                <template lwc:if={isIRDetails}>
                                    <div class="modal-body">
                                        <p>Oppdrag: <span>{interestedResource.AppointmentNumber__c}</span></p>
                                        <p>
                                            Tema:
                                            <span>{interestedResource.ServiceAppointmentFreelanceSubject__c}</span>
                                        </p>
                                        <p>Tid: <span>{interestedResource.StartAndEndDate}</span></p>
                                        <p>Adresse: <span>{interestedResource.ServiceAppointmentAddress__c}</span></p>
                                        <p>Tolkemetode: <span>{interestedResource.WorkTypeName__c}</span></p>
                                        <p>Oppdragstype: <span>{interestedResource.AssignmentType__c}</span></p>
                                        <p>Status: <span>{interestedResource.Status__c}</span></p>
                                        <p>
                                            Antall påmeldte:
                                            <span>{interestedResource.NumberOfInterestedResources__c}</span>
                                        </p>
                                        <p>
                                            Frigitt dato:
                                            <span> {interestedResource.ServiceAppointment__r.HOT_ReleaseDate__c}</span>
                                        </p>

                                        <p>
                                            Frigitt av:
                                            <span> {interestedResource.ServiceAppointment__r.HOT_ReleasedBy__c}</span>
                                        </p>
                                        <p>Frist dato:<span> {interestedResource.AppointmentDeadlineDate__c}</span></p>
                                        <p>Region:<span> {interestedResource.AppointmentServiceTerritory__c}</span></p>
                                        <p>
                                            Eier:
                                            <span>
                                                {interestedResource.ServiceAppointment__r.HOT_Request__r.OwnerName__c}</span
                                            >
                                        </p>

                                        <template lwc:if={interestedResource.WorkOrderCanceledDate__c}>
                                            <p>
                                                Avlyst dato: <span>{interestedResource.WorkOrderCanceledDate__c}</span>
                                            </p>
                                        </template>

                                        <template lwc:if={interestedResource.HOT_TermsOfAgreement__c}>
                                            <p>
                                                Avtalte betingelser:
                                                <span>{interestedResource.HOT_TermsOfAgreement__c}</span>
                                            </p>
                                        </template>
                                    </div>
                                </template>

                                <!-- Show Wage Claim Details -->
                                <template lwc:if={isWCDetails}>
                                    <div class="modal-body">
                                        <p>Oppdragsnummer: <span>{wageClaim.ServiceAppointmentName__c}</span></p>
                                        <p>Tid: <span>{wageClaim.StartAndEndDate}</span></p>
                                        <p>Poststed: <span>{wageClaim.ServiceAppointmentCity__c}</span></p>
                                        <p>Tolkemetode: <span>{wageClaim.WorkTypeName__c}</span></p>
                                        <p>Oppdragstype: <span>{wageClaim.AssignmentType__c}</span></p>
                                        <p>
                                            Eier:
                                            <span>{wageClaim.ServiceAppointment__r.HOT_Request__r.OwnerName__c}</span>
                                        </p>
                                        <p>
                                            Døv/døvblind: <span>{wageClaim.DegreeOfHearingAndVisualImpairment__c}</span>
                                        </p>
                                        <p>Status: <span>{wageClaim.Status__c}</span></p>
                                    </div>
                                </template>
                            </template>
                        </template>
                        <template lwc:else>
                            <div class="modal-body">
                                <p>Noe gikk galt!</p>
                            </div>
                        </template>
                    </template>
                </dialog>

                <c-hot_community-error-summary
                    error-list={errorList}
                    onclickedevent={handleErrorClick}
                    class="errorSummary"
                >
                </c-hot_community-error-summary>
            </div>
            <div class="main-content">
                <div class="thread-container">
                    <div class="thread-dialog">
                        <template for:each={messages} for:item="message">
                            <c-hot_messaging-Community-Message-Container_v2
                                tabindex="0"
                                message={message}
                                user-contact-id={userContactId}
                                key={message.Id}
                            ></c-hot_messaging-Community-Message-Container_v2>
                        </template>
                    </div>

                    <!-- Read by info -->
                    <div class="read-by-container">
                        <template lwc:if={readByNames}>
                            <p class="read-by-text">Sett av {readByNames}</p>
                        </template>
                    </div>
                </div>

                <!-- Helptext -->
                <template lwc:if={isHelpText}>
                    <c-helptext class="helpText" text={helptextContent} hover-text={helptextHovertext}></c-helptext>
                </template>

                <div class="textarea-container">
                    <c-textarea
                        max-length={maxLength}
                        ongetvalueontextareachange={handleTextChange}
                        desktop-style="width: 100%; height: 100%;"
                        mobile-style=""
                    ></c-textarea>
                </div>

                <div class="send-button-container">
                    <c-button
                        disabled={buttonisdisabled}
                        onbuttonclick={handleSendButtonClick}
                        button-label="Send melding"
                        type="submit"
                        button-styling="primary"
                        desktop-style="width: 10rem; justify-content: center;"
                        mobile-style="width: 9rem; justify-content: center;"
                    ></c-button>
                </div>
            </div>
        </template>
    </div>
</template>
